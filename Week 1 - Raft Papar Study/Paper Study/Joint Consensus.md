### Joint Consensus

<hr>

`Joint Consensus`는 Raft 알고리즘에서 클러스터 멤버십 변경(노드 추가, 제거 또는 업데이트)을 안전하고 일관되게 처리하기 위한 방법이다. 클러스터 구성원의 동기화와 일관성을 보장하면서도 멤버십 변경을 효과적으로 수행하기 위해 Joint Consensus를 사용한다.

Joint Consensus를 사용하지 않는다면 업데이트를 위해 특정 노드가 중단되어야 하며, 특정 상황에서 두 개의 리더가 선출되는 문제가 생길 수 있다.

Joint Consensus는 다음과 같은 특징을 갖는다:

- C_old와 C_new라는 두 파티션

  으로 나누고 두 단계에 걸쳐 적용된다(각각 두 구성의 합의가 필요하다).

  - **C_old**: 현재 구성원들의 집합이다.
  - **C_new**: 새로운 구성원들의 집합이다.

- 모든 과정은 로그로 기록되고, 모든 구성원의 합의를 통해 작동한다.

#### Joint Consensus 과정

1. **Joint Consensus(C_old_new) 전환**
   - 설정 업데이트 명령을 받으면, 리더는 Joint Consensus(C_old_new)로 전환하는 로그를 생성하고 이를 클러스터에 전파한다.
   - 이 상태에서는 C_old와 C_new의 구성원 모두의 합의가 필요하다.
2. **새로운 리더 선출**
   - C_old_new가 커밋된 시점에서 C_old의 구성원들만이 리더로 선출될 수 있다. 이는 해당 로그를 포함한 노드만이 리더가 될 수 있음을 보장한다.
3. **구성 전환**
   - C_old 구성원을 C_new로 전환하고, C_new 로그를 생성하여 전파한다.
   - C_new가 커밋된 이후로는 해당 로그를 포함한 노드들만이 리더로 선출될 수 있다.

따라서, C_old와 C_new에서 독단적으로 중복 리더가 선출되는 것을 방지한다.



### Joint Consensus 문제점

<hr>

특정한 상황에서 문제가 발생할 수 있다

- **새 노드가 빈 로그 엔트리를 가질 때**
  - 동기화에 시간이 필요하다. 이 시간 동안 Joint Consensus를 커밋하지 못하게 되는데, 이러한 노드들은 비투표 노드로 간주하고 Joint Consensus를 진행한다. 이후 이 노드가 동기화되면 다시 재구성을 한다.
- **리더가 C_new로 변경되지 못하고 C_old에 머무를 때**
  - 이 경우 리더는 리더 자격을 포기하고 팔로워로 돌아가 문제를 해결한다.
- **제거된 서버가 클러스터를 중단시킬 때**
  - 이러한 노드들은 혼자 RequestVote를 진행하고 타임아웃을 반복하여 가용성을 떨어뜨릴 수 있다. 이 문제는 리더가 존재할 때 투표를 하지 않으며, `Minimum election timeout`을 이용하여 투표를 하지 않도록 유도하여 제거된 서버로부터 방해를 최소화한다.