--- 

##### 

Raft의 메커니즘은 클러스터 내 서버들을 변경할 때 업데이트 기간 동안 서로 다른 설정들이 overlap 되는 `Joint consensus`라는 새로운 접근 방식을 사용한다.

Raft에서 클러스터는 우선 `Joint consensus`라고 불리는 중간 단계의 설정으로 전환한 후, `Joint consensus`가 커밋된 후 새 설정으로 전이한다. `Joint consensus`는 구식 설정과 새 설정 양쪽을 합쳐서 구성된다.

- 로그 엔트리들은 양쪽 설정의 모든 서버들에 복제된다.
    
- 어느 쪽 설정의 서버든 리더로 선출될 수 있다.
    
- 리더 선출, 엔트리 커밋을 위해 구식 설정의 서버들과 새 설정의 서버들 각각은 별도의 다수의 서버들(_Majority_)의 합의가 필요하다.
    

`Joint consensus`는 각각의 서버들이 설정 사이를 각각 다른 시간에 안전하게 전이할 수 있도록 해 준다. 뿐만 아니라, 설정 파일 업데이트를 서비스 중단 없이 진행할 수 있게 만들어준다.

클러스터 설정은 복제된 로그에서 특별한 엔트리들을 사용해 저장되고 통신된다.

리더가 설정 파일을 변경하라는 요청을 받게 되면, `Joint consensus`를 위한 설정을 로그 엔트리로 저장하고 이전 섹션들에서 설명한 메커니즘을 사용하여 해당 엔트리를 복제한다.

한 번 서버가 새 설정 엔트리를 로그에 추가하고 나면, 서버는 해당 설정을 모든 미래의 결정들에 사용한다. (서버는 해당 엔트리가 커밋 되었는지 여부에 상관 없이 항상 자신의 로그의 최신 설정을 사용한다.)

이것은 리더가 `Joint consensus`가 커밋될 시기를 결정하기 위해, `Joint consensus`의 설정을 사용한다는 것을 의미한다.
\

![[Pasted image 20240720052227.png]]
(새 설정을 _C_new_, 구식 설정을 _C_old_, `Joint consensus`를 _C_old_new_라고 표현)

만약 리더에 장애가 발생하면 선출된 후보자가 _C_old_new_를 받았는지 여부에 따라 새로운 리더가 _C_old_ 또는 _C_old_new_ 내에서 선출될 수 있다.

어떤 케이스에도 _C_new_는 이 기간 동안 단독으로 의사 결정을 내릴 수 없다.

한 번 _C_old_new_가 커밋되고 나면, _C_old_, _C_new_ 양쪽 모두 다른 쪽의 동의 없이 의사 결정을 내릴 수 없으며, `Leader Completeness` 성질에 의해 오직 _C_old_new_ 로그를 가지고 있는 서버만 리더로 선출될 수 있다. `Joint consensus`가 커밋되었으니 이제 리더가 안전하게 _C_new_를 로그 엔트리로 만들고 클러스터에 복제할 수 있다. 해당 설정은 서버에서 발견되는대로 바로 적용된다.

_C_new_까지 커밋되고 나면 구식 설정은 무관한 설정으로 간주되며, 새 설정으로 업데이트 되지 않은 서버들은 종료될 수 있다.

위 그림에서 볼 수 있듯이 _C_old_와 _C_new_ 모두 단독으로 의사 결정을 내릴 수 있는 시기는 존재하지 않으며, 이 점이 안정성을 보장해준다.

설정 업데이트 자동화를 위해 다루어야 하는 몇 가지 이슈들이 더 있다.