# InstallSnapshot

InstallSnapshot RPC는 새로 생성 되었거나 로그 수신에 진연이 있었던 팔로워에게 스냅샷을 보내기 위한 메커니즘의 일부이다.
이는 팔로워가 빠르게 과거 로그를 동기화 할 수 있도록 도와준다.

## InstallSnapshot의 동작 방식

InstallSnapshot RPC는 다음과 같은 필드를 포함한다.

- `term`: 리더의 term
- `leaderId`: 클라이언트를 리다이렉트할 수 있도록 팔로워에게 리더의 ID를 제공
- `lastIncludedIndex`: 이 인덱스까지의 모든 엔트리를 스냅샷이 대체
- `lastIncludedTerm`: lastIncludedIndex의 term
- `offset`: 청크가 스냅샷 파일에서 위치한 바이트 오프셋
- `data[]`: 오프셋에서 시작하는 스냅샷 청크의 원시 바이트
- `done`: 이 청크가 마지막인지 여부

<br>
InstallSnapshot의 메커니즘은 아래와 같다.

1. term이 현재 term보다 작으면 즉시 응답
2. 첫 번째 청크(오프셋이 0인 경우)인 경우 새 스냅샷 파일 생성
3. 지정된 오프셋에서 스냅샷 파일에 데이터 기록
4. done이 false인 경우 추가 데이터 청크를 기다리며 응답
5. 스냅샷 파일을 저장하고, 더 작은 인덱스를 가진 기존 또는 부분 스냅샷을 삭제
6. 기존 로그 엔트리가 스냅샷의 마지막 포함된 엔트리와 동일한 인덱스와 term을 가지는 경우 해당 로그 엔트리
7. 이후의 엔트리를 유지하고 응답
8. 전체 로그 삭제
9. 스냅샷 내용을 사용하여 상태 머신을 재설정하고 스냅샷의 클러스터 구성을 로드

## InstallSnapshot 고려사항

- 스냅샷 빈도
  - 스냅샷을 자주 남기게 되면 디스크 대역폭과 에너지가 낭비
  - 스냅샷을 드물게 찍게되면 엔트리 저장 용량이 고갈되고, 재시작 시 로그 재생 시간이 지연
- 스냅샷 작성 시간
  - 스냅샷 쓰기 시간에는 많은 시간이 소요될 수 있으며, 이로 인해 클러스터에 지연이 발생하지 않도록 해야함
  - 이를 위해 Copy-on-Write 기술을 사용하여 새로운 업데이트를 받아들이는 동안 스냅샷 작성에 영향을 주지 않도록 한다. 예를 들어, 상태 머신이 기능적 데이터 구조로 구축된 경우 자연스럽게 이를 지원한다. 또 운영 체제의 Copy-on-Write 지원을 사용할 수 있다.
