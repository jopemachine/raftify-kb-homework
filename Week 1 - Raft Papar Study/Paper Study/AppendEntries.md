### AppendEntries

<hr>

Raft에서는 모든 명령이나 상태 변화를 로그로 생성하여 작업한다. ([멤버쉽의 변화](./Membership change.md), 클라이언트의 명령 등 포함)

이때 리더는 생성된 로그를 삭제하지 못하며, 추가만 가능하다. 또한 리더는 팔로워에게 로그를 복사하여 다른 노드들과 같은 로그를 유지하려 한다.

AppendEntries RPC는 리더가 로그를 복제하는 RPC로, 팔로워들은 해당 RPC를 통해 리더의 로그를 복사한다. 이 과정에서 간단한 일관성 검사를 진행하여 적절한 인덱스와 term을 가진 로그를 복사할 수 있게 된다.

AppendEntries RPC는 추가하고자 하는 로그와 함께 바로 이전 로그 항목의 인덱스와 term을 포함한다. 팔로워들은 이 정보를 사용해 자신의 로그에서 일치하는 항목을 찾는데, 만약 일치하는 항목이 있다면 새로운 로그 항목을 추가하고, 일치하는 항목이 없다면 RPC는 거절된다. 이는 같은 인덱스와 term에 대해 무조건 하나의 엔트리만 존재하는 성질을 이용한 것이다.

### 로그 복사와 일관성 문제 해결

<hr>

리더가 영구적으로 작동하면 좋겠지만, 리더가 변경되는 상황에서는 일관성이 깨질 수 있다.

이를 해결하기 위해 새로운 리더는 팔로워의 로그를 삭제하고 자신의 로그를 덮어씌운다. 먼저, AppendEntries RPC가 실패하면 현재 로그 엔트리가 아닌 이전 로그 엔트리(이전 인덱스에 존재하는 로그 엔트리)로 다시 AppendEntries RPC를 보내는데, 이 과정은 유효한 로그가 나올 때까지 반복된다.

유효한 로그 엔트리를 찾으면 앞에 있는 로그들(유효한 인덱스보다 작은 로그들)은 모두 `Log Matching Property`에 따라 유효한 로그들이기 때문에 그대로 두고, 뒤에 있는(유효한 인덱스보다 큰 인덱스의) 로그들을 모두 리더의 로그로 덮어버린다. 이때 로그를 하나씩 복사할 수도 있고, [스냅샷](./Snapshot.md)을 이용할 수도 있다.

이로써 일관성이 깨진 팔로워들은 다시 리더와 같은 로그 엔트리를 갖도록 유지할 수 있게 된다.
