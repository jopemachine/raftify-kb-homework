### 리더 선출

<hr> 

팔로워들은 리더로부터 heartbeat를 받지 못해 타임아웃이 일어나면 그 팔로워는 후보자가 되고 `current term`을 증가시키고 자신에게 투표한 후 다른 노드들에게 투표 요청(RequestVote RPC)을 보낸다. 그 후 대다수의 노드들의 합의를 통해 리더로 선출된다. 리더로 선출된다면 바로 다른 팔로워들에게 heartbeat를 보내 자신이 리더임을 알린다.

이때 리더가 되기 위한 조건이 몇 가지 존재한다.

1. 자신의 로그가 최신일 것(팔로워는 자신의 로그보다 최신 로그를 가진 후보자에게만 투표한다).
2. 자신의 term보다 높은 term을 가진 RPC 요청이 오면 리더를 내려놓는다(이는 자신보다 최신의 로그를 갖는 노드에게 리더를 주기 위함이다).
3. 과반수 확보를 하지 못한 경우(팔로워들은 같은 term에 대해 한 번만 투표한다. 이는 중복 리더 선출을 방지하기 위함이다) 타임아웃으로 간주하고 다시 투표 요청을 한다.

### Raft 알고리즘 예시와 모순

<hr>

리더의 명령에 따라 로그를 복사하고, 리더가 없으면 새로운 리더를 뽑고, 일관성이 깨지면 리더가 로그를 덮어버리는 등 일련의 작업들로 Raft가 완전하다고 한다. 하지만 몇 가지 예시를 생각해 보면 이상한 점이 몇 가지 있다. 논문의 간단한 예시를 가정해 보면 다음과 같다.

- 리더 A가 로그 항목을 커밋.
- 노드 B가 새로운 리더가 되기 위해 투표 요청을 보냄.
- 노드 B는 리더 A의 커밋된 로그 항목을 아직 포함하지 않음.

위 상황을 보면 노드 B가 리더가 되면 리더 A의 커밋 항목이 사라지고 일관성이 깨지지 않을까 싶다. 하지만 다음과 같은 모순이 있음을 증명할 수 있다.

1. **팔로워 입장에서의 모순**

   - **커밋된 로그 항목**: 리더 A가 로그 항목을 커밋했다는 것은 과반수 이상의 노드가 해당 로그 항목을 저장하고 있다는 의미임.

   - 투표 조건

     : 팔로워들은 후보자가 자신의 로그보다 최신 로그를 가지고 있어야만 투표함.

     - 리더 A의 로그 항목이 커밋된 상태라면, 최소 과반수의 노드가 해당 로그 항목을 가지고 있다.
     - 따라서, 노드 B가 리더가 되려면 리더 A의 커밋된 로그 항목을 포함해야 함.
     - 리더 A의 커밋된 로그 항목을 포함하지 않은 노드 B는 투표를 요청해도 과반수의 투표를 얻지 못함.
     - 이로 인해 노드 B는 리더로 선출되지 않으며, 이는 팔로워 입장에서의 모순을 방지함.

2. **후보자 입장에서의 모순**

   - **Leader Completeness**: 어떤 로그 항목이 특정 term에 커밋되었다면, 그 로그 항목은 이후 모든 리더의 로그에 포함되어야 함.

   - 후보자의 조건

     : 후보자가 되기 위해서는 최신 로그를 가져야 하며, 이는 커밋된 로그 항목을 포함해야 한다는 것을 의미함.

     - 노드 B가 후보자가 되기 위해서는 리더 A의 커밋된 로그 항목을 포함해야 함.
     - 리더 A의 커밋된 로그 항목을 포함하지 않은 상태에서 노드 B가 충분한 term과 로그를 가지고 있다면, 이는 `Leader Completeness`에 위배됨.
     - 따라서, 노드 B는 리더가 될 수 없으며, 이는 후보자 입장에서의 모순을 방지함.

논문의 5.4.3 내용을 간단하게 요약한 내용이다. 위 내용을 통해 Raft에서는 리더 변경 시 일관성을 유지할 수 있다.