--- 

##### 멤버쉽 변경

이전까지 모든 예시는, 클러스터의 멤버가 정적인 상황을 가정했다면 이제는 Raft에서 어떻게 멤버쉽을 변경하는지 알아보려고 한다. 가장 단순한 방법은 모든 서버를 셧다운 시키고 서버를 추가한 다음, 실행하는 건데 이는 실용적으로 봤을 때는 쓸모가 없기 때문에 동적으로 멤버를 추가할 수 있어야 한다.

하지만, 분산 서버에서는 모든 설정을 한 순간에 변경할 수 없기 때문에 반드시 2명의 리더가 선출되는 상황이 연출될 수 있다. 아래 그림을 보면, 3개의 서버로 구성된 C_old 클러스터에서 5개의 서버로 구성된 클러스터 C_new로 전환하는 과정이다. 초록색은 과거의 설정 정보가 반영되는 시점을 나타내고 파랑색은 새로운 설정 정보가 반영되는 시점을 나타낸다. 설정 정보가 반영되는 타이밍 때문에 과반 수를 판단하는 정보가 달라서 2명의 리더가 선출될 수 있음을 보여준다.
![[Pasted image 20240720051217.png]]
3개의 서버에서 5개로 증가시키는 모습

Raft에서는 이 문제를 해결하기 위해, 스스로 **결합 합의 (join consensus)**라고 부르는 방법을 사용한다. 이 방법의 기본 아이디어는 서버 별로 새로운 설정 정보로 전환하기 까지 시간을 두는 것을 허용하는 것이다. 방법론적으로는 새로운 설정 정보를 로그 엔트리에 포함시키고 이것을 대다수 노드에 복제 되어 **커밋되고 나서야 새로운 설정 정보**를 활용한다. 이런 결합 합의 방식에서는 아래 3가지 문제가 나타날 수 있다.

![[Pasted image 20240720051231.png]]
설정 정보가 변경되는 과정, Dashed Line은 커밋되지 않은 정보를, 실선은 커밋된 정보를 나타낸다.

1. 새롭게 참여한 서버가 아직 아무런 로그도 저장하지 못한 상황, 만약 이 서버가 바로 투표에 참여하면 절대 리더로 선출되지 못하기 때문에 가용하지 못하기 때문에 Raft에서는 설정 변경 전에 투표권이 없는(Non-Voting) 멤버로 참여시켜서 먼저 동기화가 완료하고 결합 합의를 진행한다.
2. 현재 리더가 새로운 설정 정보에는 포함되어 있지 않은 경우이다. 이 경우에 리더는 본인이 C_new 설정 정보가 담긴 엔트리를 커밋한 경우 스스로 팔로워 상태로 변경하고 사임한다.
3. 새로운 설정에선 삭제된 멤버가 클러스터를 망칠 수 있다는 이슈가 있다. 우선 새 집단에서 제외 되었기 때문에 [[heartbeat.md|heartbeat]] 메시지를 수신 받지 않는다. 따라서, 스스로 후보 상태로 변경해서 선거를 진행하려고 하기 때문에 현재 리더가 팔로워 상태로 변경될 수 있다. Raft에서는 단순히 클러스터 내 노드들이 현재 자신이 리더가 존재한다고 믿는 상태라면 투표를 거부하여 이 문제를 해결한다.